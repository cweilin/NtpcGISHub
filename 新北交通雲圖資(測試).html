<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>新北市交通設備圖資</title>
    
    <!-- 引入 OpenLayers CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v8.2.0/ol.css">
    
    <style>
        :root { --primary-color: #0066cc; }
        body, html { margin: 0; padding: 0; height: 100%; width: 100%; font-family: "Microsoft JhengHei", sans-serif; overflow: hidden; }
        #map { height: 100%; width: 100%; background: #f0f0f0; }
        
        /* 左側資訊與圖例面板 */
        .info-panel {
            position: absolute; top: 20px; left: 20px; z-index: 1000;
            background: rgba(255, 255, 255, 0.95); padding: 15px;
            border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            width: 260px; border-top: 5px solid var(--primary-color);
        }
        .info-panel h2 { margin: 0; font-size: 16px; color: #333; }
        .info-panel p.subtitle { margin: 5px 0 10px 0; font-size: 12px; color: #666; }
        
        .legend-list { margin-top: 10px; }
        .legend-item { 
            font-size: 13px; 
            margin-bottom: 8px; 
            display: flex; 
            align-items: center; 
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: background 0.2s;
        }
        .legend-item:hover { background: rgba(0,0,0,0.05); }
        .legend-item input { margin-right: 10px; cursor: pointer; width: 16px; height: 16px; }
        .legend-icon { width: 24px; height: 24px; margin-right: 10px; border: 1px solid #eee; background: #fff; pointer-events: none; }
        .legend-label { flex-grow: 1; pointer-events: none; }
    </style>
</head>
<body>

    <div class="info-panel">
        <h2>新北市交通設施圖層</h2>
        <div id="legend-container" class="legend-list">
            <!-- 圖例與開關將透過 JS 動態產生 -->
        </div>
        <hr style="border: 0; border-top: 1px solid #ddd; margin: 10px 0;">
        <p style="font-size: 11px; color: #888;">底圖：國土測繪中心 (NLSC)<br>圖資：NtpcGISHub WMS</p>
    </div>

    <!-- 地圖容器 -->
    <div id="map"></div>

    <!-- 引入 OpenLayers JS -->
    <script src="https://cdn.jsdelivr.net/npm/ol@v8.2.0/dist/ol.js"></script>

    <script>
        const wmsBaseUrl = 'https://projects.geosense.tw/geoserver/NtpcGISHub/wms';
        
        // 配置圖層資訊，並加入 zIndex 權重
        // zIndex 越高，顯示位置越靠上層
        const layersConfig = [
            { id: 'cctv', name: 'CCTV 監視器', layerName: 'NtpcGISHub:NtpcGISHub_DeviceCCTV', zIndex: 30 },
            { id: 'cms', name: 'CMS 資訊看板', layerName: 'NtpcGISHub:NtpcGISHub_DeviceCMS', zIndex: 20 },
            { id: 'sig', name: 'SIG 交通號誌', layerName: 'NtpcGISHub:NtpcGISHub_DeviceSIG', zIndex: 10 }
        ];

        // 1. 設定底圖 (國土測繪中心通用版電子地圖)
        const nlscLayer = new ol.layer.Tile({
            source: new ol.source.XYZ({
                url: 'https://wmts.nlsc.gov.tw/wmts/EMAP/default/GoogleMapsCompatible/{z}/{y}/{x}',
                attributions: '&copy; <a href="https://maps.nlsc.gov.tw/">內政部國土測繪中心</a>'
            }),
            zIndex: 0 // 底圖設定為最低層
        });

        // 2. 初始化 WMS 圖層並建立 UI
        const legendContainer = document.getElementById('legend-container');
        const wmsLayers = [];

        layersConfig.forEach(conf => {
            // 建立 OpenLayers WMS 圖層
            const layer = new ol.layer.Tile({
                source: new ol.source.TileWMS({
                    url: wmsBaseUrl,
                    params: { 
                        'LAYERS': conf.layerName, 
                        'TILED': true, 
                        'VERSION': '1.1.1',
                        'TRANSPARENT': true 
                    },
                    serverType: 'geoserver'
                }),
                visible: true,
                zIndex: conf.zIndex // 套用權重，確保顯示順序
            });
            wmsLayers.push(layer);

            // 建立 UI 項目
            const item = document.createElement('label');
            item.className = 'legend-item';
            
            // 核取方塊
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.checked = true;
            checkbox.onchange = (e) => {
                layer.setVisible(e.target.checked);
            };

            // 圖例縮圖
            const iconUrl = `${wmsBaseUrl}?REQUEST=GetLegendGraphic&VERSION=1.1.0&FORMAT=image/png&LAYER=${conf.layerName}`;
            const icon = document.createElement('img');
            icon.src = iconUrl;
            icon.className = 'legend-icon';

            // 文字標籤
            const label = document.createElement('span');
            label.className = 'legend-label';
            label.innerText = conf.name;

            // 組裝並加入容器
            item.appendChild(checkbox);
            item.appendChild(icon);
            item.appendChild(label);
            legendContainer.appendChild(item);
        });

        // 3. 初始化地圖
        const map = new ol.Map({
            target: 'map',
            layers: [
                nlscLayer,
                ...wmsLayers
            ],
            view: new ol.View({
                center: ol.proj.fromLonLat([121.46516, 25.01236]), // 新北市政府
                zoom: 16
            })
        });

    </script>
</body>
</html>